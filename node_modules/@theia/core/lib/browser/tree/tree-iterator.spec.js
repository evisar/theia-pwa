"use strict";
/********************************************************************************
 * Copyright (C) 2018 TypeFox and others.
 *
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License v. 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0.
 *
 * This Source Code may also be made available under the following Secondary
 * Licenses when the conditions for such availability set forth in the Eclipse
 * Public License v. 2.0 are satisfied: GNU General Public License, version 2
 * with the GNU Classpath Exception which is available at
 * https://www.gnu.org/software/classpath/license.html.
 *
 * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0
 ********************************************************************************/
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spread = (this && this.__spread) || function () {
    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));
    return ar;
};
Object.defineProperty(exports, "__esModule", { value: true });
var chai_1 = require("chai");
var inversify_1 = require("inversify");
var objects_1 = require("../../common/objects");
var logger_1 = require("../../common/logger");
var mock_logger_1 = require("../../common/test/mock-logger");
var tree_search_1 = require("./tree-search");
var fuzzy_search_1 = require("./fuzzy-search");
var tree_1 = require("./tree");
var mock_tree_model_1 = require("./test/mock-tree-model");
var tree_navigation_1 = require("./tree-navigation");
var tree_model_1 = require("./tree-model");
var tree_selection_1 = require("./tree-selection");
var tree_selection_impl_1 = require("./tree-selection-impl");
var tree_expansion_1 = require("./tree-expansion");
var tree_iterator_1 = require("./tree-iterator");
// tslint:disable:no-unused-expression
// tslint:disable:max-line-length
describe('tree-iterator', function () {
    var model = createTreeModel();
    var findNode = function (id) { return model.getNode(id); };
    beforeEach(function () {
        model.root = mock_tree_model_1.MockTreeModel.HIERARCHICAL_MOCK_ROOT();
    });
    it('should include root', function () {
        var expected = ['1'];
        var actual = __spread(new tree_iterator_1.BottomUpTreeIterator(findNode('1'))).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('should return `undefined` after consuming the iterator', function () {
        var itr = new tree_iterator_1.BottomUpTreeIterator(findNode('1'));
        var next = itr.next();
        while (!next.done) {
            chai_1.expect(next.value).to.be.not.undefined;
            next = itr.next();
        }
        chai_1.expect(next.done).to.be.true;
        chai_1.expect(next.value).to.be.undefined;
    });
    it('depth-first (no collapsed nodes)', function () {
        var expected = ['1', '1.1', '1.1.1', '1.1.2', '1.2', '1.2.1', '1.2.1.1', '1.2.1.2', '1.2.2', '1.2.3', '1.3'];
        var actual = __spread(new tree_iterator_1.DepthFirstTreeIterator(model.root)).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('depth-first (with collapsed nodes)', function () {
        collapseNode('1.1', '1.2.1');
        var expected = ['1', '1.1', '1.2', '1.2.1', '1.2.2', '1.2.3', '1.3'];
        var actual = __spread(new tree_iterator_1.DepthFirstTreeIterator(model.root, { pruneCollapsed: true })).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('breadth-first (no collapsed nodes)', function () {
        var expected = ['1', '1.1', '1.2', '1.3', '1.1.1', '1.1.2', '1.2.1', '1.2.2', '1.2.3', '1.2.1.1', '1.2.1.2'];
        var actual = __spread(new tree_iterator_1.BreadthFirstTreeIterator(model.root)).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('breadth-first (with collapsed nodes)', function () {
        collapseNode('1.1', '1.2.1');
        var expected = ['1', '1.1', '1.2', '1.3', '1.2.1', '1.2.2', '1.2.3'];
        var actual = __spread(new tree_iterator_1.BreadthFirstTreeIterator(model.root, { pruneCollapsed: true })).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('bottom-up (no collapsed nodes)', function () {
        var expected = ['1.2.2', '1.2.1.2', '1.2.1.1', '1.2.1', '1.2', '1.1.2', '1.1.1', '1.1', '1'];
        var actual = __spread(new tree_iterator_1.BottomUpTreeIterator(findNode('1.2.2'))).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('bottom-up (with collapsed nodes)', function () {
        collapseNode('1.1', '1.2.1');
        var expected = ['1.2.2', '1.2.1', '1.2', '1.1', '1'];
        var actual = __spread(new tree_iterator_1.BottomUpTreeIterator(findNode('1.2.2'), { pruneCollapsed: true })).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('top-down (no collapsed nodes)', function () {
        var expected = ['1.1.2', '1.2', '1.2.1', '1.2.1.1', '1.2.1.2', '1.2.2', '1.2.3', '1.3'];
        var actual = __spread(new tree_iterator_1.TopDownTreeIterator(findNode('1.1.2'))).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    it('top-down (with collapsed nodes)', function () {
        collapseNode('1.2.1');
        var expected = ['1.1.2', '1.2', '1.2.1', '1.2.2', '1.2.3', '1.3'];
        var actual = __spread(new tree_iterator_1.TopDownTreeIterator(findNode('1.1.2'), { pruneCollapsed: true })).map(function (node) { return node.id; });
        chai_1.expect(expected).to.be.deep.equal(actual);
    });
    function collapseNode() {
        var ids = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            ids[_i] = arguments[_i];
        }
        ids.map(findNode).filter(objects_1.notEmpty).filter(tree_expansion_1.ExpandableTreeNode.is).forEach(function (node) {
            model.collapseNode(node);
            chai_1.expect(node).to.have.property('expanded', false);
        });
    }
    function createTreeModel() {
        var container = new inversify_1.Container({ defaultScope: 'Singleton' });
        container.bind(tree_1.TreeImpl).toSelf();
        container.bind(tree_1.Tree).toService(tree_1.TreeImpl);
        container.bind(tree_selection_impl_1.TreeSelectionServiceImpl).toSelf();
        container.bind(tree_selection_1.TreeSelectionService).toService(tree_selection_impl_1.TreeSelectionServiceImpl);
        container.bind(tree_expansion_1.TreeExpansionServiceImpl).toSelf();
        container.bind(tree_expansion_1.TreeExpansionService).toService(tree_expansion_1.TreeExpansionServiceImpl);
        container.bind(tree_navigation_1.TreeNavigationService).toSelf();
        container.bind(tree_model_1.TreeModelImpl).toSelf();
        container.bind(tree_model_1.TreeModel).toService(tree_model_1.TreeModelImpl);
        container.bind(tree_search_1.TreeSearch).toSelf();
        container.bind(fuzzy_search_1.FuzzySearch).toSelf();
        container.bind(mock_logger_1.MockLogger).toSelf();
        container.bind(logger_1.ILogger).to(mock_logger_1.MockLogger).inSingletonScope();
        return container.get(tree_model_1.TreeModel);
    }
});
describe('iterators', function () {
    it('as-iterator', function () {
        var array = [1, 2, 3, 4];
        var itr = tree_iterator_1.Iterators.asIterator(array);
        var next = itr.next();
        while (!next.done) {
            var value = next.value;
            chai_1.expect(value).to.be.not.undefined;
            var index = array.indexOf(value);
            chai_1.expect(index).to.be.not.equal(-1);
            array.splice(index, 1);
            next = itr.next();
        }
        chai_1.expect(array).to.be.empty;
    });
    it('cycle - without start', function () {
        this.timeout(1000);
        var array = [1, 2, 3, 4];
        var itr = tree_iterator_1.Iterators.cycle(array);
        var visitedItems = new Set();
        var next = itr.next();
        while (!next.done) {
            var value = next.value;
            chai_1.expect(value).to.be.not.undefined;
            if (visitedItems.has(value)) {
                chai_1.expect(Array.from(visitedItems).sort()).to.be.deep.equal(array.sort());
                break;
            }
            visitedItems.add(value);
            next = itr.next();
        }
    });
    it('cycle - with start', function () {
        this.timeout(1000);
        var array = [1, 2, 3, 4];
        var itr = tree_iterator_1.Iterators.cycle(array, 2);
        var visitedItems = new Set();
        var next = itr.next();
        chai_1.expect(next.value).to.be.equal(2);
        while (!next.done) {
            var value = next.value;
            chai_1.expect(value).to.be.not.undefined;
            if (visitedItems.has(value)) {
                chai_1.expect(Array.from(visitedItems).sort()).to.be.deep.equal(array.sort());
                break;
            }
            visitedItems.add(value);
            next = itr.next();
        }
    });
});
//# sourceMappingURL=tree-iterator.spec.js.map